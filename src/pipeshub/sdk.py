"""Code generated by Speakeasy (https://speakeasy.com). DO NOT EDIT."""

from .basesdk import BaseSDK
from .httpclient import AsyncHttpClient, ClientOwner, HttpClient, close_clients
from .sdkconfiguration import SDKConfiguration
from .utils.logger import Logger, get_default_logger
from .utils.retries import RetryConfig
import httpx
import importlib
from pipeshub import models
from pipeshub._hooks import SDKHooks
from pipeshub.types import OptionalNullable, UNSET
import sys
from typing import Any, Callable, Optional, TYPE_CHECKING, Union, cast
import weakref

if TYPE_CHECKING:
    from pipeshub.agentconversations import AgentConversations
    from pipeshub.agents import Agents
    from pipeshub.agenttemplates import AgentTemplates
    from pipeshub.aimodelsconfiguration import AiModelsConfiguration
    from pipeshub.aimodelsproviders import AiModelsProviders
    from pipeshub.authconfig_sdk import AuthConfigSDK
    from pipeshub.authenticationconfiguration import AuthenticationConfiguration
    from pipeshub.authenticationconfigurations import AuthenticationConfigurations
    from pipeshub.connector import Connector
    from pipeshub.connectorconfiguration import ConnectorConfiguration
    from pipeshub.connectorconfigurations import ConnectorConfigurations
    from pipeshub.connectorcontrols import ConnectorControls
    from pipeshub.connectorfilters import ConnectorFilters
    from pipeshub.connectorinstances import ConnectorInstances
    from pipeshub.connectoroauth import ConnectorOAuth
    from pipeshub.connectoroauthconfiguration_1 import ConnectorOAuthConfiguration1
    from pipeshub.connectoroauthconfiguration_2 import ConnectorOauthConfiguration2
    from pipeshub.connectoroauthconfigurations import ConnectorOAuthConfigurations
    from pipeshub.connectorregistry import ConnectorRegistry
    from pipeshub.connectors import Connectors
    from pipeshub.connectorservice import ConnectorService
    from pipeshub.conversations import Conversations
    from pipeshub.crawlingjobs import CrawlingJobs
    from pipeshub.doclingservice import DoclingService
    from pipeshub.doclingservices import DoclingServices
    from pipeshub.documentbuffer import DocumentBuffer
    from pipeshub.documentbuffers import DocumentBuffers
    from pipeshub.documentmanagement import DocumentManagement
    from pipeshub.documentupload import DocumentUpload
    from pipeshub.emailoperations import EmailOperations
    from pipeshub.folders import Folders
    from pipeshub.indexingservices import IndexingServices
    from pipeshub.knowledgebases import KnowledgeBases
    from pipeshub.mailconfigurations import MailConfigurations
    from pipeshub.metricscollection import MetricsCollection
    from pipeshub.oauth_sdk import OauthSDK
    from pipeshub.oauthapps import OauthApps
    from pipeshub.oauthconfiguration import OauthConfiguration
    from pipeshub.oauthprovider import OauthProvider
    from pipeshub.openidconnect_1 import OpenidConnect1
    from pipeshub.openidconnect_2 import OpenIDConnect2
    from pipeshub.organizationauthconfig import OrganizationAuthConfig
    from pipeshub.organizationauthconfigs import OrganizationAuthConfigs
    from pipeshub.organizations import Organizations
    from pipeshub.permissions_sdk import PermissionsSDK
    from pipeshub.platformsettings_sdk import PlatformSettingsSDK
    from pipeshub.publicurls import PublicUrls
    from pipeshub.queryservice import QueryService
    from pipeshub.queuemanagement import QueueManagement
    from pipeshub.records import Records
    from pipeshub.saml import Saml
    from pipeshub.semanticsearch import SemanticSearch
    from pipeshub.smtpconfiguration import SMTPConfiguration
    from pipeshub.smtpconfigurations import SMTPConfigurations
    from pipeshub.storageconfiguration import StorageConfiguration
    from pipeshub.teams import Teams
    from pipeshub.upload import Upload
    from pipeshub.uploads import Uploads
    from pipeshub.useraccount import UserAccount
    from pipeshub.usergroups import UserGroups
    from pipeshub.users import Users
    from pipeshub.versioncontrol import VersionControl
    from pipeshub.webhooks import Webhooks


class Pipeshub(BaseSDK):
    r"""PipesHub API: Unified API documentation for PipesHub services.

    PipesHub is an enterprise-grade platform providing:
    - User authentication and management
    - Document storage and version control
    - Knowledge base management
    - Enterprise search and conversational AI
    - Third-party integrations via connectors
    - System configuration management
    - Crawling job scheduling
    - Email services

    ## Authentication
    Most endpoints require JWT Bearer token authentication. Some internal endpoints use scoped tokens for service-to-service communication.

    ## Base URLs
    All endpoints use the `/api/v1` prefix unless otherwise noted.

    """

    user_account: "UserAccount"
    oauth: "OauthSDK"
    oauth_provider: "OauthProvider"
    openid_connect: "OpenidConnect1"
    open_id_connect: "OpenIDConnect2"
    oauth_apps: "OauthApps"
    organization_auth_configs: "OrganizationAuthConfigs"
    organization_auth_config: "OrganizationAuthConfig"
    saml: "Saml"
    users: "Users"
    r"""User management operations"""
    teams: "Teams"
    r"""Team management operations"""
    organizations: "Organizations"
    r"""Organization management operations"""
    user_groups: "UserGroups"
    document_upload: "DocumentUpload"
    document_management: "DocumentManagement"
    document_buffers: "DocumentBuffers"
    document_buffer: "DocumentBuffer"
    version_control: "VersionControl"
    knowledge_bases: "KnowledgeBases"
    records: "Records"
    r"""Record management and operations"""
    folders: "Folders"
    r"""Folder organization and management"""
    upload: "Upload"
    r"""File upload operations"""
    uploads: "Uploads"
    connector: "Connector"
    r"""Connector-related operations"""
    connectors: "Connectors"
    permissions: "PermissionsSDK"
    r"""Permission management for knowledge bases"""
    conversations: "Conversations"
    r"""AI-powered conversational chat management with citations and follow-up questions"""
    semantic_search: "SemanticSearch"
    agent_templates: "AgentTemplates"
    agents: "Agents"
    r"""Custom AI agents with specialized capabilities and tool integrations"""
    agent_conversations: "AgentConversations"
    connector_registry: "ConnectorRegistry"
    connector_instances: "ConnectorInstances"
    connector_configurations: "ConnectorConfigurations"
    connector_configuration: "ConnectorConfiguration"
    connector_controls: "ConnectorControls"
    connector_o_auth: "ConnectorOAuth"
    connector_filters: "ConnectorFilters"
    oauth_configuration: "OauthConfiguration"
    storage_configuration: "StorageConfiguration"
    smtp_configurations: "SMTPConfigurations"
    smtp_configuration: "SMTPConfiguration"
    auth_config: "AuthConfigSDK"
    authentication_configurations: "AuthenticationConfigurations"
    authentication_configuration: "AuthenticationConfiguration"
    ai_models_configuration: "AiModelsConfiguration"
    ai_models_providers: "AiModelsProviders"
    connector_o_auth_configuration: "ConnectorOAuthConfiguration1"
    connector_oauth_configuration: "ConnectorOauthConfiguration2"
    connector_o_auth_configurations: "ConnectorOAuthConfigurations"
    public_urls: "PublicUrls"
    platform_settings: "PlatformSettingsSDK"
    metrics_collection: "MetricsCollection"
    crawling_jobs: "CrawlingJobs"
    queue_management: "QueueManagement"
    email_operations: "EmailOperations"
    mail_configurations: "MailConfigurations"
    query_service: "QueryService"
    indexing_services: "IndexingServices"
    connector_service: "ConnectorService"
    webhooks: "Webhooks"
    r"""Webhook handlers for real-time updates"""
    docling_service: "DoclingService"
    docling_services: "DoclingServices"
    _sub_sdk_map = {
        "user_account": ("pipeshub.useraccount", "UserAccount"),
        "oauth": ("pipeshub.oauth_sdk", "OauthSDK"),
        "oauth_provider": ("pipeshub.oauthprovider", "OauthProvider"),
        "openid_connect": ("pipeshub.openidconnect_1", "OpenidConnect1"),
        "open_id_connect": ("pipeshub.openidconnect_2", "OpenIDConnect2"),
        "oauth_apps": ("pipeshub.oauthapps", "OauthApps"),
        "organization_auth_configs": (
            "pipeshub.organizationauthconfigs",
            "OrganizationAuthConfigs",
        ),
        "organization_auth_config": (
            "pipeshub.organizationauthconfig",
            "OrganizationAuthConfig",
        ),
        "saml": ("pipeshub.saml", "Saml"),
        "users": ("pipeshub.users", "Users"),
        "teams": ("pipeshub.teams", "Teams"),
        "organizations": ("pipeshub.organizations", "Organizations"),
        "user_groups": ("pipeshub.usergroups", "UserGroups"),
        "document_upload": ("pipeshub.documentupload", "DocumentUpload"),
        "document_management": ("pipeshub.documentmanagement", "DocumentManagement"),
        "document_buffers": ("pipeshub.documentbuffers", "DocumentBuffers"),
        "document_buffer": ("pipeshub.documentbuffer", "DocumentBuffer"),
        "version_control": ("pipeshub.versioncontrol", "VersionControl"),
        "knowledge_bases": ("pipeshub.knowledgebases", "KnowledgeBases"),
        "records": ("pipeshub.records", "Records"),
        "folders": ("pipeshub.folders", "Folders"),
        "upload": ("pipeshub.upload", "Upload"),
        "uploads": ("pipeshub.uploads", "Uploads"),
        "connector": ("pipeshub.connector", "Connector"),
        "connectors": ("pipeshub.connectors", "Connectors"),
        "permissions": ("pipeshub.permissions_sdk", "PermissionsSDK"),
        "conversations": ("pipeshub.conversations", "Conversations"),
        "semantic_search": ("pipeshub.semanticsearch", "SemanticSearch"),
        "agent_templates": ("pipeshub.agenttemplates", "AgentTemplates"),
        "agents": ("pipeshub.agents", "Agents"),
        "agent_conversations": ("pipeshub.agentconversations", "AgentConversations"),
        "connector_registry": ("pipeshub.connectorregistry", "ConnectorRegistry"),
        "connector_instances": ("pipeshub.connectorinstances", "ConnectorInstances"),
        "connector_configurations": (
            "pipeshub.connectorconfigurations",
            "ConnectorConfigurations",
        ),
        "connector_configuration": (
            "pipeshub.connectorconfiguration",
            "ConnectorConfiguration",
        ),
        "connector_controls": ("pipeshub.connectorcontrols", "ConnectorControls"),
        "connector_o_auth": ("pipeshub.connectoroauth", "ConnectorOAuth"),
        "connector_filters": ("pipeshub.connectorfilters", "ConnectorFilters"),
        "oauth_configuration": ("pipeshub.oauthconfiguration", "OauthConfiguration"),
        "storage_configuration": (
            "pipeshub.storageconfiguration",
            "StorageConfiguration",
        ),
        "smtp_configurations": ("pipeshub.smtpconfigurations", "SMTPConfigurations"),
        "smtp_configuration": ("pipeshub.smtpconfiguration", "SMTPConfiguration"),
        "auth_config": ("pipeshub.authconfig_sdk", "AuthConfigSDK"),
        "authentication_configurations": (
            "pipeshub.authenticationconfigurations",
            "AuthenticationConfigurations",
        ),
        "authentication_configuration": (
            "pipeshub.authenticationconfiguration",
            "AuthenticationConfiguration",
        ),
        "ai_models_configuration": (
            "pipeshub.aimodelsconfiguration",
            "AiModelsConfiguration",
        ),
        "ai_models_providers": ("pipeshub.aimodelsproviders", "AiModelsProviders"),
        "connector_o_auth_configuration": (
            "pipeshub.connectoroauthconfiguration_1",
            "ConnectorOAuthConfiguration1",
        ),
        "connector_oauth_configuration": (
            "pipeshub.connectoroauthconfiguration_2",
            "ConnectorOauthConfiguration2",
        ),
        "connector_o_auth_configurations": (
            "pipeshub.connectoroauthconfigurations",
            "ConnectorOAuthConfigurations",
        ),
        "public_urls": ("pipeshub.publicurls", "PublicUrls"),
        "platform_settings": ("pipeshub.platformsettings_sdk", "PlatformSettingsSDK"),
        "metrics_collection": ("pipeshub.metricscollection", "MetricsCollection"),
        "crawling_jobs": ("pipeshub.crawlingjobs", "CrawlingJobs"),
        "queue_management": ("pipeshub.queuemanagement", "QueueManagement"),
        "email_operations": ("pipeshub.emailoperations", "EmailOperations"),
        "mail_configurations": ("pipeshub.mailconfigurations", "MailConfigurations"),
        "query_service": ("pipeshub.queryservice", "QueryService"),
        "indexing_services": ("pipeshub.indexingservices", "IndexingServices"),
        "connector_service": ("pipeshub.connectorservice", "ConnectorService"),
        "webhooks": ("pipeshub.webhooks", "Webhooks"),
        "docling_service": ("pipeshub.doclingservice", "DoclingService"),
        "docling_services": ("pipeshub.doclingservices", "DoclingServices"),
    }

    def __init__(
        self,
        server_url: str,
        bearer_auth: Optional[Union[Optional[str], Callable[[], Optional[str]]]] = None,
        client: Optional[HttpClient] = None,
        async_client: Optional[AsyncHttpClient] = None,
        retry_config: OptionalNullable[RetryConfig] = UNSET,
        timeout_ms: Optional[int] = None,
        debug_logger: Optional[Logger] = None,
    ) -> None:
        r"""Instantiates the SDK configuring it with the provided parameters.

        :param bearer_auth: The bearer_auth required for authentication
        :param server_idx: The index of the server to use for all methods
        :param server_url: The server URL to use for all methods
        :param url_params: Parameters to optionally template the server URL with
        :param client: The HTTP client to use for all synchronous methods
        :param async_client: The Async HTTP client to use for all asynchronous methods
        :param retry_config: The retry configuration to use for all supported methods
        :param timeout_ms: Optional request timeout applied to each operation in milliseconds
        """
        client_supplied = True
        if client is None:
            client = httpx.Client(follow_redirects=True)
            client_supplied = False

        assert issubclass(
            type(client), HttpClient
        ), "The provided client must implement the HttpClient protocol."

        async_client_supplied = True
        if async_client is None:
            async_client = httpx.AsyncClient(follow_redirects=True)
            async_client_supplied = False

        if debug_logger is None:
            debug_logger = get_default_logger()

        assert issubclass(
            type(async_client), AsyncHttpClient
        ), "The provided async_client must implement the AsyncHttpClient protocol."

        security: Any = None
        if callable(bearer_auth):
            # pylint: disable=unnecessary-lambda-assignment
            security = lambda: models.Security(bearer_auth=bearer_auth())
        else:
            security = models.Security(bearer_auth=bearer_auth)

        BaseSDK.__init__(
            self,
            SDKConfiguration(
                client=client,
                client_supplied=client_supplied,
                async_client=async_client,
                async_client_supplied=async_client_supplied,
                security=security,
                server_url=server_url,
                retry_config=retry_config,
                timeout_ms=timeout_ms,
                debug_logger=debug_logger,
            ),
            parent_ref=self,
        )

        hooks = SDKHooks()

        # pylint: disable=protected-access
        self.sdk_configuration.__dict__["_hooks"] = hooks

        self.sdk_configuration = hooks.sdk_init(self.sdk_configuration)

        weakref.finalize(
            self,
            close_clients,
            cast(ClientOwner, self.sdk_configuration),
            self.sdk_configuration.client,
            self.sdk_configuration.client_supplied,
            self.sdk_configuration.async_client,
            self.sdk_configuration.async_client_supplied,
        )

    def dynamic_import(self, modname, retries=3):
        for attempt in range(retries):
            try:
                return importlib.import_module(modname)
            except KeyError:
                # Clear any half-initialized module and retry
                sys.modules.pop(modname, None)
                if attempt == retries - 1:
                    break
        raise KeyError(f"Failed to import module '{modname}' after {retries} attempts")

    def __getattr__(self, name: str):
        if name in self._sub_sdk_map:
            module_path, class_name = self._sub_sdk_map[name]
            try:
                module = self.dynamic_import(module_path)
                klass = getattr(module, class_name)
                instance = klass(self.sdk_configuration, parent_ref=self)
                setattr(self, name, instance)
                return instance
            except ImportError as e:
                raise AttributeError(
                    f"Failed to import module {module_path} for attribute {name}: {e}"
                ) from e
            except AttributeError as e:
                raise AttributeError(
                    f"Failed to find class {class_name} in module {module_path} for attribute {name}: {e}"
                ) from e

        raise AttributeError(
            f"'{type(self).__name__}' object has no attribute '{name}'"
        )

    def __dir__(self):
        default_attrs = list(super().__dir__())
        lazy_attrs = list(self._sub_sdk_map.keys())
        return sorted(list(set(default_attrs + lazy_attrs)))

    def __enter__(self):
        return self

    async def __aenter__(self):
        return self

    def __exit__(self, exc_type, exc_val, exc_tb):
        if (
            self.sdk_configuration.client is not None
            and not self.sdk_configuration.client_supplied
        ):
            self.sdk_configuration.client.close()
        self.sdk_configuration.client = None

    async def __aexit__(self, exc_type, exc_val, exc_tb):
        if (
            self.sdk_configuration.async_client is not None
            and not self.sdk_configuration.async_client_supplied
        ):
            await self.sdk_configuration.async_client.aclose()
        self.sdk_configuration.async_client = None
